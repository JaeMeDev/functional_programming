### 레거시 코드

→ 오래전에 만든 것으로, 지금 당장 고칠 수 없어서 그대로 사용해야 하는 코드

### 방어적 복사

→ 데이터가 바뀌는 것을 완벽히 막아주는 원칙

## 방어적 복사 규칙

방어적 복사는 데이터를 변경할 수도 있는 코드와 불변성 코드 사이에 데이터를 주고받기 위한 원칙이다. 여기에는 두 가지 규칙이 있다.

### 규칙 1: 데이터가 안전한 코드에서 나갈 때 복사하기

변경 불가능한 데이터가 신뢰할 수 없는 코드로 나갈 때, 아래 단계로 원본 데이터를 보호할 수 있다.

1. 불변성 데이터를 위한 깊은 복사본을 만든다.
2. 신뢰할 수 없는 코드로 복사본을 전달한다.

### 규칙 2: 안전한 코드로 데이터가 들어올 때 복사하기

신뢰할 수 없는 코드에서 변경될 수도 있는 데이터가 들어온다면 다음 단계를 따른다.

1. 변경될 수도 있는 데이터가 들어오면 바로 깊은 복사본을 만들어 안전한 코드로 전달한다.
2. 복사본을 안전한 코드에서 사용한다.

## 카피-온-라이트와 방어적 복사의 비교

### 카피-온-라이트

- 언제 쓸까?
    - 통제할 수 있는 데이터를 바꿀 때 카피-온-라이트를 사용한다.
- 어디서 쓰나?
    - 안전지대 어디서나 쓸 수 있다. 사실 카피-온-라이트가 불변성을 가진 안전지대를 만든다.
- 복사 방식
    - 얕은 복사(상대적으로 비용이 적게 든다.)
- 규칙
    1. 바꿀 데이터의 얕은 복사를 만든다.
    2. 복사본을 변경한다.
    3. 복사본을 리턴한다.

### 방어적 복사

- 언제 쓸까?
    - 신뢰할 수 없는 코드와 데이터를 주고받아야 할 때 방어적 복사를 쓴다.
- 어디서 쓰나?
    - 안전지대의 경계에서 데이터가 오고 갈 때 방어적 복사를 쓴다.
- 복사 방식
    - 깊은 복사(상대적으로 비용이 많이 든다.)
- 규칙
    1. 안전지대로 들어오는 데이터에 깊은 복사를 만든다.
    2. 안전지대에서 나가는 데이터에 깊은 복사를 만든다.

## 깊은 복사

깊은 복사는 원본과 어떤 데이터 구조도 공유하지 않는 것이 얕은 복사와 차이점이다. 중첩된 모든 객체나 배열을 복사한다. 얕은 복사에서는 바뀌지 않은 값이라면 원본과 복사본이 데이터를 공유한다.

## 자바스크립트에서 깊은 복사를 구현하는 것은 어렵다.

깊은 복사는 단순한 개념이기 때문에 만들기 쉬워 보인다. 하지만 자바스크립트에서는 표준 라이브러리가 좋지 않아 만들기가 어렵다.

그래서 `Lodash` 에 있는 깊은 복사 함수를 쓰는 것을 추천한다. Lodash에 cloneDeep 함수는 중첩된 데이터에 깊은 복사를 한다.